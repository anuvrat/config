# ── General ───────────────────────────────────────────────────────────────
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",xterm-256color*:Tc"   # true color for iTerm2
set -g mouse on
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on
set -g history-limit 50000
set -g escape-time 0                               # no delay after Escape
set -g focus-events on

# ── Prefix ───────────────────────────────────────────────────────────────
unbind C-b
set -g prefix `
bind ` send-prefix

# ── Splits (retain current path) ─────────────────────────────────────────
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
unbind '"'
unbind %

# New window retains path
bind c new-window -c "#{pane_current_path}"

# ── Vim-like pane navigation ─────────────────────────────────────────────
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Resize panes
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# ── Seamless vim/tmux navigation (Ctrl-h/j/k/l) ─────────────────────────
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|l?n?vim?x?|fzf)(diff)?$'"
bind -n C-h if-shell "$is_vim" 'send-keys C-h' 'select-pane -L'
bind -n C-j if-shell "$is_vim" 'send-keys C-j' 'select-pane -D'
bind -n C-k if-shell "$is_vim" 'send-keys C-k' 'select-pane -U'
bind -n C-l if-shell "$is_vim" 'send-keys C-l' 'select-pane -R'
bind -T copy-mode-vi C-h select-pane -L
bind -T copy-mode-vi C-j select-pane -D
bind -T copy-mode-vi C-k select-pane -U
bind -T copy-mode-vi C-l select-pane -R

# ── Quick toggles ────────────────────────────────────────────────────────
bind Tab last-window                               # toggle last window
bind BTab switch-client -l                         # toggle last session

# ── fzf session/window picker ────────────────────────────────────────────
bind f display-popup -E -w 60% -h 60% "\
  tmux list-windows -a -F '#{session_name}:#{window_index} #{window_name}' \
  | fzf --reverse --border=none \
        --color=bg+:#283457,bg:#1a1b26,spinner:#7dcfff,hl:#7aa2f7 \
        --color=fg:#c0caf5,header:#7aa2f7,info:#e0af68,pointer:#7dcfff \
        --color=marker:#9ece6a,fg+:#c0caf5,prompt:#bb9af7,hl+:#7aa2f7 \
  | cut -d' ' -f1 \
  | xargs tmux switch-client -t"

# ── Popup terminal ───────────────────────────────────────────────────────
bind g display-popup -E -w 80% -h 80% -d "#{pane_current_path}"

# ── Copy mode (vi) ───────────────────────────────────────────────────────
setw -g mode-keys vi
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "pbcopy"

# ── Reload config ────────────────────────────────────────────────────────
bind r source-file ~/.tmux.conf \; display "Config reloaded"

# ── Tokyo Night status bar ───────────────────────────────────────────────
set -g status-position bottom
set -g status-interval 5
set -g status-style "bg=#16161e,fg=#565f89"

# Left: session name
set -g status-left "#[fg=#7dcfff,bold] #S "
set -g status-left-length 30

# Right: zoom indicator + time
set -g status-right "#{?window_zoomed_flag,#[fg=#e0af68 bold] Z ,}#[fg=#565f89] %H:%M "
set -g status-right-length 20

# Window tabs
set -g window-status-format "#[fg=#565f89] #I:#W "
set -g window-status-current-format "#[fg=#bb9af7,bold] #I:#W "
set -g window-status-separator ""

# Pane borders
set -g pane-border-style "fg=#565f89"
set -g pane-active-border-style "fg=#7aa2f7"

# Message style
set -g message-style "bg=#16161e,fg=#c0caf5"
set -g message-command-style "bg=#16161e,fg=#c0caf5"

# Clock
setw -g clock-mode-colour "#7aa2f7"
